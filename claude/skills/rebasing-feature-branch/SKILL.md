---
name: rebasing-feature-branch
description: フィーチャーブランチをmainブランチにリベースするワークフローを提供する。「リベースして」「mainを取り込んで」「mainに追従して」「rebase」といった依頼、またはフィーチャーブランチがmainから乖離している場合に使用する。
context: fork
allowed-tools:
  - Bash
  - Read
  - Glob
  - Grep
  - AskUserQuestion
---

# フィーチャーブランチのリベース

フィーチャーブランチにmainブランチの最新変更を、リベースで見通しよく安全に取り込む。

**フロー**: 状態確認 → main最新化 → リベース → プッシュ

---

## 実行手順

### Step 1: 現在の状態を確認する

```bash
git branch --show-current && git status --short
```

**ブランチの確認:**

- `main` や `staging` などの保護ブランチにいる場合 → ユーザーにフィーチャーブランチへの切り替えを促して中断する
- フィーチャーブランチにいることを確認し、ブランチ名を `FEATURE_BRANCH` として記憶する

**未コミットの変更がある場合:**

AskUserQuestionで対応を選択してもらう:

```json
{
  "question": "未コミットの変更があります。どうしますか？",
  "options": [
    { "label": "コミットする", "description": "変更をコミットしてからリベースする" },
    { "label": "スタッシュする", "description": "git stashで退避し、リベース後に復元する" }
  ]
}
```

ワーキングツリーがクリーンになってから次へ進む。

### Step 2: mainブランチを最新化する

```bash
git checkout main && git pull origin main
```

### Step 3: フィーチャーブランチに戻ってリベースする

Step 1で記憶した `FEATURE_BRANCH` を使う。Bashの環境変数はコマンド間で保持されないため、ブランチ名を直接埋め込む:

```bash
git checkout <FEATURE_BRANCH> && git rebase main
```

### Step 4: リモートにプッシュする

リベース成功後、force pushする。`--force-with-lease` を使うことで、他の人がプッシュした変更を誤って上書きするリスクを軽減する:

```bash
git push --force-with-lease origin <FEATURE_BRANCH>
```

---

## コンフリクト発生時

リベース中にコンフリクトが発生した場合:

### 1. コンフリクトの内容を把握する

- コンフリクトが発生したファイルを一覧で提示する
- 各ファイルのコンフリクト箇所（`<<<<<<<` 〜 `>>>>>>>`）を読み、HEAD（main側）とフィーチャーブランチ側の変更内容を把握する

### 2. 解消方針をユーザーに提案する

コンフリクト解消はユーザーの意図に大きく依存する。どちらの変更を残すかは機械的に判断できないため、方針を提示して承認を得る:

- **どちらを優先するか？** main側 / フィーチャーブランチ側 / 両方取り込む
- **取り込み後に調整が必要か？** 必要なら具体的に何が必要か？
- **解消後のコード例**

承認を得てからコードを修正する。

### 3. ユーザーの承認後にコードを修正する

- 承認を得たら、コードを修正してコンフリクトマーカーを除去する
- リンターが自動で変更する可能性がある場合は、その影響も考慮する

### 4. 解消後にリベースを継続する

```bash
git add <解消したファイル> && git rebase --continue
```

- 後続のコミットで同じファイルに再度コンフリクトが発生する場合がある
- その場合は手順1〜3を繰り返す。同じパターンでも再度の承認を得てからコードを修正する

### 5. すべてのコンフリクト解消後にプッシュする

```bash
git push --force-with-lease origin <FEATURE_BRANCH>
```

---

## 注意事項

- リベースを使うべきではない場合（共有ブランチ、公開済みコミットなど）は処理を中断して、ユーザーに報告する
- `--force` ではなく `--force-with-lease` を使用する
- mainブランチに直接force pushしない

---
name: review-pr
description: PRのコードレビューを実施する。PR番号またはブランチ名を受け取り、差分を取得してレビューコメントを作成する。「PRレビューして」「#123をレビュー」のように使う。チェックアウトの意図を含めるとブランチをチェックアウトしてレビューする。
context: fork
allowed-tools:
  - Bash
  - Read
  - Glob
  - Grep
---

# PRレビュー

## 概要

**目的**: レビュアーとしてアサインされたPRを、コード差分・PR説明・既存コメントを元にレビューする。

**フロー**: 引数解析・チェックアウト → PR情報取得 → レビュー実施 → 結果表示 → アクション案内

---

## 実行手順

### Step 1: 引数を解析し、チェックアウトモードを判定・実行する

**YOU MUST: 他のすべてのステップに先立ち、このステップを最初に完了すること。**

#### 1-1. 引数からPR番号とチェックアウトの意図を読み取る

- **PR特定**: 引数中の数字、GitHub PR URL、またはブランチ名をPR特定に使う
- **チェックアウト判定**: 引数に「ブランチをチェックアウトしてローカルファイルを参照しながらレビューしたい」という意図が読み取れる場合はチェックアウトモードにする。明確でない場合はチェックアウトしない
  - 意図ありの例: `checkout`, `チェックアウト`, `co`, `switch`, `ブランチ切り替え`, `ローカルで`, `手元で`, `落として`
  - 意図なしの例: PR番号やURLのみ、レビュー観点の指示のみ

例:

- `/review-pr 123` → チェックアウトなし
- `/review-pr https://github.com/org/repo/pull/123 checkout` → チェックアウトあり
- `/review-pr 123 チェックアウトして` → チェックアウトあり
- `/review-pr 123 ブランチ切り替えてレビューして` → チェックアウトあり
- `/review-pr 123 手元で見たい` → チェックアウトあり
- `/review-pr 123 セキュリティ観点で見て` → チェックアウトなし

#### 1-2. 判定結果を出力する

```
モード: チェックアウトあり / チェックアウトなし
PR: <特定したPR番号>
```

#### 1-3. チェックアウトモードの場合、ブランチを切り替える

チェックアウトなしの場合は1-3をスキップしてStep 2に進む。

```bash
git stash list
git status --short
```

- 未コミットの変更がある場合はスタッシュを提案する
- 現在のブランチ名を保存しておく（Step 4で復帰するため）

```bash
ORIGINAL_BRANCH=$(git branch --show-current)
gh pr checkout <PR番号>
```

---

### Step 2: PR情報を取得する

引数から特定したPR番号を使い、リポジトリ情報と合わせてPRの全体像を取得する。

**リポジトリのオーナーとリポジトリ名を取得:**

```bash
gh repo view --json owner,name --jq '"\(.owner.login)/\(.name)"'
```

**PRの基本情報を取得:**

```bash
gh pr view <PR番号またはブランチ名> --json number,title,body,baseRefName,headRefName,files,author,state
```

- タイトル、説明、ベースブランチ、ヘッドブランチ、変更ファイル一覧を把握する
- PRの状態がOPEN以外の場合はユーザーに通知して確認を取る

**コード差分を取得:**

```bash
gh pr diff <PR番号>
```

**既存のレビューコメントを取得:**

```bash
gh api repos/{owner}/{repo}/pulls/{number}/comments --jq '.[] | {path: .path, line: .original_line, body: .body, user: .user.login, created_at: .created_at}'
```

**会話コメント（議論の経緯）を取得:**

```bash
gh api repos/{owner}/{repo}/issues/{number}/comments --jq '.[] | {body: .body, user: .user.login, created_at: .created_at}'
```

取得した情報をもとに、PRの目的・背景・これまでの議論を整理してユーザーに提示する。

---

### Step 3: レビューを実施する

差分を読み、以下の観点でレビューコメントを作成する:

#### レビュー観点

1. **バグ・ロジックの問題**
   - オフバイワンエラー、null参照、境界値の見落とし
   - 非同期処理の競合状態、エラーハンドリングの漏れ
   - 型の不整合、暗黙の型変換

2. **セキュリティリスク**
   - インジェクション（SQL、XSS、コマンド）
   - 認証・認可の不備
   - 機密情報のハードコード・ログ出力

3. **可読性・命名**
   - 命名の一貫性、意図が伝わる命名か
   - 関数・メソッドの責務が明確か
   - 不要な複雑さがないか

4. **テストの妥当性**
   - 変更に対応するテストが追加されているか
   - エッジケースがカバーされているか
   - テストが実装の意図を正しく検証しているか

#### チェックアウトモードの場合の追加確認

ローカルファイルを参照して、差分だけでは分からない以下を確認する:

- 変更箇所の前後のコンテキスト（周辺コード）
- インポート元や呼び出し元への影響
- 設定ファイルや型定義との整合性

---

### Step 4: レビュー結果を出力する

レビュー結果をClaude Code上に表示する。**GitHubへの自動投稿はしない。**

#### 出力フォーマット

まずPRの概要サマリーを提示する:

```
## PRサマリー
- **タイトル**: <タイトル>
- **作成者**: <作成者>
- **ベースブランチ**: <base> ← <head>
- **変更ファイル数**: <N>ファイル
```

次にレビュー指摘事項をファイル・行番号ごとにまとめる:

```
## レビュー指摘事項

### <ファイルパス>

**L<行番号>** [<重要度>] <指摘内容>
> <該当コードの引用>
<理由と改善案>
```

重要度は以下の3段階:

- **must**: バグ、セキュリティリスクなど、マージ前に修正が必要
- **should**: 可読性や設計の改善など、強く推奨
- **nit**: 些細な改善提案、好みの範囲

最後に総評を述べる:

```
## 総評
<PRの全体的な評価と、approve / request changes / comment の推奨>
```

#### チェックアウトモードの場合: ローカル検証の提案

チェックアウトモードの場合、レビュー結果の後に「ローカル検証の手順」セクションを出力する。

PRの変更内容とプロジェクト構成（`package.json`, `Makefile`, `docker-compose.yml` 等）を読み取り、以下を提案する:

```
## ローカル検証

### 環境準備
<依存関係のインストールやビルドが必要な場合のコマンド>

### 検証手順
1. <PRの変更内容に基づく具体的な確認項目と手順>
2. ...

### 確認ポイント
- <正常系: こう操作したらこう動くべき>
- <異常系: こう操作したらこうなるべき>
- <回帰: 既存機能が壊れていないことの確認方法>
```

提案の指針:

- プロジェクトの起動コマンドやテストコマンドは、設定ファイルから正確に読み取る
- PRの説明や変更ファイルから、何をどう検証すべきかを具体的に記述する
- 手順はユーザーがそのままターミナルで実行できる粒度にする
- 検証手順の実行はユーザーに委ねる（自動実行はしない）

---

### Step 5: レビュー後の処理

**チェックアウトしたかどうかはStep 1-2の判定結果を参照する。**

**チェックアウトした場合:**

元のブランチに戻る:

```bash
git checkout "$ORIGINAL_BRANCH"
```

スタッシュした変更がある場合は復元を提案する:

```bash
git stash pop
```

**共通:**

- レビュー結果の末尾に、ユーザーが取れるアクションを案内する:
  - 特定の行にコメント投稿 → `gh api` でPRレビューコメント作成
  - 全体コメント投稿 → `gh pr review --comment`
  - approve → `gh pr review --approve`
  - 変更リクエスト → `gh pr review --request-changes`
- セッションに記憶を残したくない場合のために `/rewind` の使用を案内する

---

## 注意事項

- GitHubへの投稿（コメント、approve、request changes）は必ずユーザーの承認を得てから実行する
- PRの差分が大きい場合は、変更ファイルをカテゴリ別に整理して段階的にレビューする
- 既存のレビューコメントと重複する指摘は避ける
- チェックアウトモードでは、レビュー完了後に必ず元のブランチに戻す提案をする
- PRの作成者への敬意を忘れず、建設的なフィードバックを心がける
